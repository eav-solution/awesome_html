<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Face Recognition - Alarm System</title>
    <style>
        /* Gi·ªØ nguy√™n to√†n b·ªô Style c≈© */
        body {
            margin: 0;
            background: #0f0f0f;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            color: #00ffcc;
        }

        .container {
            position: relative;
            margin-top: 20px;
            border: 2px solid #333;
            box-shadow: 0 0 20px #00ffcc20;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .controls {
            margin-top: 20px;
            z-index: 10;
            display: flex;
            gap: 10px;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        input {
            padding: 10px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
            outline: none;
            font-family: inherit;
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            background: #00ffcc;
            color: #000;
            border: none;
            font-weight: bold;
            border-radius: 4px;
            transition: 0.2s;
        }

        button:hover {
            background: #fff;
            box-shadow: 0 0 10px #00ffcc;
        }

        .status {
            margin-top: 10px;
            font-size: 14px;
            color: #888;
        }

        .status.ready {
            color: #00ff00;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>

<body>

    <h2 style="margin-bottom: 0;">AI FACE SECURITY</h2>
    <div class="status" id="status">üîÑ ƒêang k·∫øt n·ªëi m√°y ch·ªß Model...</div>

    <div class="container">
        <video id="video" width="720" height="560" autoplay muted></video>
    </div>

    <div class="controls">
        <input type="text" id="faceName" placeholder="T√™n ƒë·ªëi t∆∞·ª£ng...">
        <button onclick="addFace()">SCAN & SAVE</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const status = document.getElementById('status');

        // --- C·∫§U H√åNH √ÇM THANH ---
        const alarmSound = new Audio('noti.wav'); // File √¢m thanh c·∫£nh b√°o
        let lastAlarmTime = 0; // Bi·∫øn l∆∞u th·ªùi gian ƒë·ªÉ tr√°nh spam √¢m thanh
        const ALARM_COOLDOWN = 3000; // Ch·ªâ b√°o ƒë·ªông l·∫°i sau 3 gi√¢y
        // -------------------------

        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

        let labeledFaceDescriptors = [];
        let faceMatcher = null;

        Promise.all([
            faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]).then(startVideo).catch(err => {
            console.error(err);
            status.innerText = "‚ùå L·ªói t·∫£i Model (Ki·ªÉm tra Internet)";
            status.style.color = "red";
        });

        function startVideo() {
            navigator.mediaDevices.getUserMedia({ video: {} })
                .then(stream => video.srcObject = stream)
                .catch(err => console.error(err));
        }

        video.addEventListener('play', () => {
            status.innerText = "‚úÖ H·ªÜ TH·ªêNG S·∫¥N S√ÄNG";
            status.classList.add('ready');

            const canvas = faceapi.createCanvasFromMedia(video);
            document.querySelector('.container').append(canvas);

            const displaySize = { width: video.width, height: video.height };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video)
                    .withFaceLandmarks()
                    .withFaceDescriptors();

                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                if (faceMatcher) {
                    const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));

                    results.forEach((result, i) => {
                        const box = resizedDetections[i].detection.box;
                        const { label, distance } = result;

                        let color = '#FF0000'; // Unknown
                        let text = `UNKNOWN ${(Math.round(distance * 100))}`;

                        if (label !== 'unknown') {
                            color = '#00FF00'; // Known
                            const accuracy = Math.round((1 - distance) * 100);
                            text = `${label.toUpperCase()} [${accuracy}%]`;
                        } else {
                            // --- LOGIC B√ÅO ƒê·ªòNG ---
                            const now = Date.now();
                            // N·∫øu l√† unknown v√† ƒë√£ qua th·ªùi gian ch·ªù (3s)
                            if (now - lastAlarmTime > ALARM_COOLDOWN) {
                                console.log("‚ö†Ô∏è PH√ÅT HI·ªÜN X√ÇM NH·∫¨P!");
                                alarmSound.play().catch(e => console.log("Ch∆∞a th·ªÉ ph√°t √¢m thanh (c·∫ßn t∆∞∆°ng t√°c ng∆∞·ªùi d√πng tr∆∞·ªõc):", e));
                                lastAlarmTime = now;
                            }
                            // ---------------------
                        }

                        const drawBox = new faceapi.draw.DrawBox(box, { label: text, boxColor: color });
                        drawBox.draw(canvas);
                    });
                } else {
                    faceapi.draw.drawDetections(canvas, resizedDetections);
                }
            }, 100);
        });

        async function addFace() {
            const name = document.getElementById('faceName').value;
            if (!name) return alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n!");

            status.innerText = "‚è≥ ƒêang ph√¢n t√≠ch khu√¥n m·∫∑t...";

            const detection = await faceapi.detectSingleFace(video)
                .withFaceLandmarks()
                .withFaceDescriptor();

            if (detection) {
                const newDescriptor = new faceapi.LabeledFaceDescriptors(name, [detection.descriptor]);
                labeledFaceDescriptors.push(newDescriptor);
                faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.6);

                status.innerText = `‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu sinh tr·∫Øc h·ªçc: ${name}`;
                document.getElementById('faceName').value = '';

                document.body.style.background = "#003300";
                setTimeout(() => document.body.style.background = "#0f0f0f", 200);
            } else {
                alert("‚ùå Kh√¥ng t√¨m th·∫•y khu√¥n m·∫∑t r√µ r√†ng!");
                status.innerText = "‚úÖ H·ªÜ TH·ªêNG S·∫¥N S√ÄNG";
            }
        }
    </script>
</body>

</html>